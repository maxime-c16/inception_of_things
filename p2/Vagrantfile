# p2/Vagrantfile
# Setup configuration header

Vagrant.configure("2") do |config|
    config.vm.box = "almalinux/9"
    config.vm.provider "virtualbox"
    config.vm.boot_timeout = 600
    
    # Disable default synced folder (requires Guest Additions)
    config.vm.synced_folder ".", "/vagrant", disabled: true
    
    LOGIN = "macauchy"
    SERVER_IP = "192.168.56.110"

    # --- SERVER NODE --- (controller)
    config.vm.define "#{LOGIN}S" do |server|
        server.vm.hostname = "#{LOGIN}S"
        server.vm.network "private_network", ip: "#{SERVER_IP}"
        
        server.vm.provider "virtualbox" do |vb|
            vb.name = "#{LOGIN}S"
            vb.memory = "4096"
            vb.cpus = 2

            # Network configuration for nested virtualization
            vb.customize ["modifyvm", :id, "--nested-hw-virt", "on"]
            vb.customize ["modifyvm", :id, "--nestedpaging", "on"]
            vb.customize ["modifyvm", :id, "--paravirtprovider", "kvm"]
        end

        # Copy confs directory to VM before provisioning
        server.vm.provision "file", source: "confs", destination: "/home/vagrant/confs"
        
        # Provisioning script
        server.vm.provision "shell", path: "scripts/setup_server.sh"
    end
end
