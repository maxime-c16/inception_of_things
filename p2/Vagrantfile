# p2/Vagrantfile
# Setup configuration header

Vagrant.configure("2") do |config|
    config.vm.box = "almalinux/9"
    config.vm.provider "virtualbox"  # Force VirtualBox as the provider
    config.vm.boot_timeout = 600     # 10 minutes timeout
    
    LOGIN = "macauchy"
    SERVER_IP = "192.168.56.110"

    # --- SERVER NODE --- (controller)
    config.vm.define "#{LOGIN}S" do |server|
        server.vm.hostname = "#{LOGIN}S"
        
        # FIX: Corrected typo "privqate_network" -> "private_network"
        server.vm.network "private_network", ip: "#{SERVER_IP}"
        
        server.vm.provider "virtualbox" do |vb|
            vb.name = "#{LOGIN}S"
            vb.memory = "4096" # SUGGESTION: 2GB is very low for nested virtualization. I bumped it to 4GB.
            vb.cpus = 2        # Keep this at 2 to minimize race conditions

            # --- CRITICAL FIXES FOR VBOX 7 CRASH ---
            # 1. Enable Nested VT-x (Required for your project)
            vb.customize ["modifyvm", :id, "--nested-hw-virt", "on"]
            
            # 2. Disable Nested Paging (Fixes the PGM/Ring0 Assertion crash)
            vb.customize ["modifyvm", :id, "--nestedpaging", "off"]
            
            # 3. Force KVM Paravirtualization (Stabilizes Linux guests)
            vb.customize ["modifyvm", :id, "--paravirtprovider", "kvm"]
        end

        # Provisioning script
        server.vm.provision "shell", path: "scripts/setup_server.sh"
    end
end
